#!/usr/bin/env python3
import argparse
import subprocess
import sys
import time
from pathlib import Path

# add src to path so we can import our modules
sys.path.insert(0, str(Path(__file__).parent / "src"))

import daemon_manager as dm
import installer

# ANSI color codes for vibrant output
class Color:
    CYAN = '\033[96m'
    MAGENTA = '\033[95m'
    YELLOW = '\033[93m'
    GREEN = '\033[92m'
    BLUE = '\033[94m'
    RED = '\033[91m'
    RESET = '\033[0m'
    BOLD = '\033[1m'


# ##################################################################
# show banner
# displays a vibrant colorful banner for the auto daemon manager
def show_banner() -> None:
    banner = f"""
{Color.CYAN}╔═══════════════════════════════════════════════════════════════╗
{Color.CYAN}║  {Color.YELLOW}{Color.BOLD} ▄▄▄       █    ██ ▄▄▄█████▓ ▒█████  {Color.CYAN}                        ║
{Color.CYAN}║  {Color.YELLOW}{Color.BOLD}▒████▄     ██  ▓██▒▓  ██▒ ▓▒▒██▒  ██▒{Color.CYAN}                        ║
{Color.CYAN}║  {Color.GREEN}{Color.BOLD}▒██  ▀█▄  ▓██  ▒██░▒ ▓██░ ▒░▒██░  ██▒{Color.CYAN}                        ║
{Color.CYAN}║  {Color.GREEN}{Color.BOLD}░██▄▄▄▄██ ▓▓█  ░██░░ ▓██▓ ░ ▒██   ██░{Color.CYAN}                        ║
{Color.CYAN}║  {Color.MAGENTA}{Color.BOLD} ▓█   ▓██▒▒▒█████▓   ▒██▒ ░ ░ ████▓▒░{Color.CYAN}                        ║
{Color.CYAN}║  {Color.MAGENTA}{Color.BOLD} ▒▒   ▓▒█░░▒▓▒ ▒ ▒   ▒ ░░   ░ ▒░▒░▒░ {Color.CYAN}                        ║
{Color.CYAN}║  {Color.BLUE}{Color.BOLD}  ▒   ▒▒ ░░░▒░ ░ ░     ░      ░ ▒ ▒░ {Color.CYAN}                        ║
{Color.CYAN}║  {Color.BLUE}{Color.BOLD}  ░   ▒    ░░░ ░ ░   ░      ░ ░ ░ ▒  {Color.CYAN}                        ║
{Color.CYAN}║  {Color.RED}{Color.BOLD}      ░  ░   ░                  ░ ░  {Color.CYAN}                        ║
{Color.CYAN}║                                                               ║
{Color.CYAN}║      {Color.GREEN}Daemon Process Manager{Color.CYAN} - {Color.MAGENTA}Keep Your Services Running{Color.CYAN}      ║
{Color.CYAN}╚═══════════════════════════════════════════════════════════════╝{Color.RESET}
"""
    print(banner)


# ##################################################################
# command ps
# lists all configured processes with their current status
def command_ps(args: argparse.Namespace) -> int:
    processes = dm.list_processes()
    if not processes:
        print("No processes configured")
        return 0

    # calculate column widths
    name_width = max(len(name) for name in processes.keys())
    name_width = max(name_width, len("NAME"))

    # print header
    print(f"{'NAME':<{name_width}}  {'PID':>6}  {'PORT':>5}")

    # print each process
    for name, info in sorted(processes.items()):
        pid = info["pid"]
        port = info.get("port")
        pid_str = str(pid) if pid is not None else "dead"
        port_str = str(port) if port is not None else "-"
        print(f"{name:<{name_width}}  {pid_str:>6}  {port_str:>5}")
    return 0


# ##################################################################
# command start
# starts a configured process by name
def command_start(args: argparse.Namespace) -> int:
    name = args.name
    try:
        pid = dm.start_process(name)
        print(f"Started {name} with pid {pid}")
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# command stop
# stops a running process by name
def command_stop(args: argparse.Namespace) -> int:
    name = args.name
    try:
        dm.stop_process(name)
        print(f"Stopped {name}")
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# command restart
# restarts a process by stopping and starting it
def command_restart(args: argparse.Namespace) -> int:
    name = args.name
    try:
        # stop if running
        pid = dm.get_process_status(name)
        if pid is not None:
            dm.stop_process(name)
            print(f"Stopped {name}")

        # start
        pid = dm.start_process(name)
        print(f"Started {name} with pid {pid}")
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# command add
# adds a new process to config and starts it immediately
def command_add(args: argparse.Namespace) -> int:
    name = args.name
    command = " ".join(args.command)
    port = args.port
    try:
        dm.add_process(name, command, port=port)
        print(f"Added {name}")
        pid = dm.start_process(name)
        print(f"Started {name} with pid {pid}")
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# command update
# updates settings for an existing process
def command_update(args: argparse.Namespace) -> int:
    name = args.name
    try:
        dm.update_process(name, port=args.port, workdir=args.workdir)
        print(f"Updated {name}")
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# command remove
# removes a process from config and stops it if running
def command_remove(args: argparse.Namespace) -> int:
    name = args.name
    try:
        dm.remove_process(name)
        print(f"Removed {name}")
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# command show
# displays the command line for a configured process
def command_show(args: argparse.Namespace) -> int:
    name = args.name
    try:
        command = dm.get_process_command(name)
        print(f"{name}: {command}")
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# command log
# displays or tails the latest log file for a process
def command_log(args: argparse.Namespace) -> int:
    name = args.name
    log_path = dm.get_latest_log_path(name)

    if log_path is None:
        print(f"No log file found for {name}")
        return 1

    if args.file:
        print(log_path)
        return 0

    if args.tail:
        subprocess.run(["tail", "-f", str(log_path)])
        return 0

    # default: cat the file
    print(log_path.read_text(), end="")
    return 0


# ##################################################################
# command start all
# starts all configured processes that are not currently running
def command_start_all(args: argparse.Namespace) -> int:
    dm.start_all_processes()
    print("Started all configured processes")
    return 0


# ##################################################################
# command watch
# continuously monitors and restarts dead processes with exponential backoff
def command_watch(args: argparse.Namespace) -> int:
    print("Watching processes for automatic restart...")
    try:
        while True:
            dm.watch_and_restart_processes()
            time.sleep(1)
    except KeyboardInterrupt:
        print("\nStopped watching")
        return 0


# ##################################################################
# command install
# installs auto daemon and creates wrapper script in ~/bin
def command_install(args: argparse.Namespace) -> int:
    try:
        installer.install()
        return 0
    except Exception as err:
        print(f"Error: {err}")
        return 1


# ##################################################################
# main
# parses arguments and dispatches to the appropriate command handler
def main(argv: list[str]) -> int:
    parser = argparse.ArgumentParser(
        prog="auto",
        description="Manage daemon processes"
    )
    parser.add_argument("-q", "--quiet", action="store_true",
                       help="Suppress the banner output")
    subparsers = parser.add_subparsers(dest="command", required=True)

    # ps command
    ps_parser = subparsers.add_parser("ps", help="List all processes with status")
    ps_parser.set_defaults(func=command_ps)

    # start command
    start_parser = subparsers.add_parser("start", help="Start a process")
    start_parser.add_argument("name", help="Process name")
    start_parser.set_defaults(func=command_start)

    # stop command
    stop_parser = subparsers.add_parser("stop", help="Stop a process")
    stop_parser.add_argument("name", help="Process name")
    stop_parser.set_defaults(func=command_stop)

    # restart command
    restart_parser = subparsers.add_parser("restart", help="Restart a process")
    restart_parser.add_argument("name", help="Process name")
    restart_parser.set_defaults(func=command_restart)

    # add command
    add_parser = subparsers.add_parser("add", help="Add a new process and start it")
    add_parser.add_argument("name", help="Process name")
    add_parser.add_argument("command", nargs="+", help="Command to run")
    add_parser.add_argument("--port", type=int, help="Port the process listens on")
    add_parser.set_defaults(func=command_add)

    # update command
    update_parser = subparsers.add_parser("update", help="Update settings for an existing process")
    update_parser.add_argument("name", help="Process name")
    update_parser.add_argument("--port", type=int, help="Port the process listens on")
    update_parser.add_argument("--workdir", help="Working directory for the process")
    update_parser.set_defaults(func=command_update)

    # remove command
    remove_parser = subparsers.add_parser("remove", help="Remove a process")
    remove_parser.add_argument("name", help="Process name")
    remove_parser.set_defaults(func=command_remove)

    # show command
    show_parser = subparsers.add_parser("show", help="Show process command")
    show_parser.add_argument("name", help="Process name")
    show_parser.set_defaults(func=command_show)

    # log command
    log_parser = subparsers.add_parser("log", help="Show process log")
    log_parser.add_argument("name", help="Process name")
    log_parser.add_argument("--file", action="store_true", help="Print log file path only")
    log_parser.add_argument("--tail", action="store_true", help="Tail the log file")
    log_parser.set_defaults(func=command_log)

    # start-all command (used by LaunchAgent)
    start_all_parser = subparsers.add_parser("start-all", help="Start all configured processes")
    start_all_parser.set_defaults(func=command_start_all)

    # watch command
    watch_parser = subparsers.add_parser("watch", help="Monitor and restart dead processes")
    watch_parser.set_defaults(func=command_watch)

    # install command
    install_parser = subparsers.add_parser("install", help="Install auto daemon and wrapper script")
    install_parser.set_defaults(func=command_install)

    args = parser.parse_args(argv)
    if not args.quiet:
        show_banner()
    return args.func(args)


# ##################################################################
# standard python pattern for dispatching main
if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
